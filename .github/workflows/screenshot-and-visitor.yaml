name: screenshot-and-visitor

on:
  push:
    branches: [gh-pages, main]
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      add_like:
        description: 'Add your like (only one per user allowed)'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pages: read
  actions: read

env:
  BADGE_STYLE: 'for-the-badge'
  BADGE_COLOR: 'brightgreen'
  LIKES_COLOR: 'gold'
  DATA_DIR: 'assets/db'
  SCREENSHOT_DIR: 'assets'

jobs:
  update-readme-and-visitor:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20.x'
      PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: 'false'

    steps:
      - name: üî• Checkout repository
        uses: actions/checkout@v4
        with:
          # ‚úÖ FIX: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ PAT_TOKEN –¥–ª—è –æ–±—Ö–æ–¥—É protected branch
          token: ${{ secrets.PAT_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: üö´ Check if auto-commit
        id: check_commit
        run: |
          if [[ "${{ github.event.head_commit.message }}" == *"Auto-update:"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Auto-commit detected - will skip workflow"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Regular commit - proceeding with workflow"
          fi

      - name: üöÄ Initialize workflow
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          DATA_DIR="$DATA_DIR"
          SCREENSHOT_DIR="$SCREENSHOT_DIR"
          mkdir -p "$DATA_DIR" "$SCREENSHOT_DIR"

          for README_FILE in README.md README.en.md README.de.md; do
            if [ -f "$README_FILE" ]; then
              awk '/<!-- AUTOGEN:STATS -->/{exit} {print}' "$README_FILE" > "${README_FILE}.before.tmp"
              awk '/<!-- END:AUTOGEN -->/{found=1; next} found{print}' "$README_FILE" > "${README_FILE}.after.tmp"
              {
                cat "${README_FILE}.before.tmp"
                echo "<!-- AUTOGEN:STATS -->"
                echo "üìÑ Updating statistics and screenshot..."
                echo "<!-- END:AUTOGEN -->"
                cat "${README_FILE}.after.tmp"
              } > "$README_FILE"
              rm -f "${README_FILE}.before.tmp" "${README_FILE}.after.tmp"
              echo "üöÄ Initialized $README_FILE"
            fi
          done
          echo "üöÄ Workflow initialized, all README files cleared"

      - name: üìä Collect all statistics
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          DATA_DIR="$DATA_DIR"
          STATS_FILE="$DATA_DIR/stats-data.json"
          USERS_FILE="$DATA_DIR/unique-users.json"
          STARGAZERS_FILE="$DATA_DIR/stargazers.json"
          MANUAL_LIKES_FILE="$DATA_DIR/manual-likes.json"
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          echo "üìä Collecting all repository statistics..."

          # VISITORS / VIEWS
          echo "üëÄ Fetching traffic (views)..."
          TRAFFIC_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO/traffic/views")
          HTTP_CODE=$(echo "$TRAFFIC_RESPONSE" | tail -n1)
          TRAFFIC_JSON=$(echo "$TRAFFIC_RESPONSE" | sed '$d')
          if [ "$HTTP_CODE" = "200" ] && echo "$TRAFFIC_JSON" | jq -e '.count >= 0 or .uniques >= 0' >/dev/null 2>&1; then
            VIEWS=$(echo "$TRAFFIC_JSON" | jq -r '.count // .uniques // 0')
          else
            VIEWS=0
            echo "‚ö†Ô∏è Traffic API returned $HTTP_CODE or invalid data, using 0"
          fi
          [[ "$VIEWS" =~ ^[0-9]+$ ]] || VIEWS=0
          echo "üëÄ Views: $VIEWS"

          # STARS & LIKES
          echo "‚≠ê Processing stars and likes..."
          STARS_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO/stargazers")

          # ‚úÖ FIX: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —î –≤–∞–ª—ñ–¥–Ω–∏–º JSON –º–∞—Å–∏–≤–æ–º
          if echo "$STARS_RESPONSE" | jq -e 'type == "array"' >/dev/null 2>&1 && [ "$(echo "$STARS_RESPONSE" | jq 'length')" -gt 0 ]; then
            STARS_USERS=$(echo "$STARS_RESPONSE" | jq -r '[.[].login] | unique')
            STARS_COUNT=$(echo "$STARS_USERS" | jq 'length')
            STARGAZERS_DETAILED=$(echo "$STARS_RESPONSE" | jq '[.[] | {login: .login, avatar_url: .avatar_url, html_url: .html_url, starred_at: now | strftime("%Y-%m-%d %H:%M:%S")}]')
            echo "‚≠ê Found $STARS_COUNT stargazers"
          else
            echo "‚≠ê No stargazers found or API error"
            STARS_USERS='[]'
            STARS_COUNT=0
            STARGAZERS_DETAILED='[]'
          fi

          # ‚úÖ FIX: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è stats —Ñ–∞–π–ª—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é —Å—Ç—Ä—É–∫—Ç—É—Ä–æ—é
          [ ! -f "$STATS_FILE" ] && echo '{"manual_likes": {"users": [], "details": []}}' > "$STATS_FILE"

          # Manual likes processing
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.add_like }}" = "true" ]; then
            USER="${{ github.actor }}"
            # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
            IS_STARGAZER=$(echo "$STARS_USERS" | jq --arg user "$USER" 'if type == "array" then (index($user) != null) else false end' 2>/dev/null || echo "false")
            
            if [ "$IS_STARGAZER" = "false" ]; then
              # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
              ALREADY_LIKED=$(jq --arg user "$USER" 'if .manual_likes.users then (.manual_likes.users | index($user) != null) else false end' "$STATS_FILE" 2>/dev/null || echo "false")
              if [ "$ALREADY_LIKED" = "false" ]; then
                CURRENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S")
                jq --arg user "$USER" --arg time "$CURRENT_TIME" \
                  '.manual_likes.users += [$user] | .manual_likes.details += [{login: $user, liked_at: $time, type: "manual"}]' \
                  "$STATS_FILE" > tmp.json && mv tmp.json "$STATS_FILE"
                echo "üíñ New manual like from $USER!"
              else
                echo "üíñ User $USER already liked"
              fi
            else
              echo "‚≠ê User $USER is already a stargazer"
            fi
          fi

          # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
          MANUAL_LIKES_COUNT=$(jq -r 'if .manual_likes.users then (.manual_likes.users | length) else 0 end' "$STATS_FILE" 2>/dev/null || echo "0")
          TOTAL_LIKES=$((STARS_COUNT + MANUAL_LIKES_COUNT))

          # Create badges (schemaVersion 1 for shields.io endpoint)
          echo "{\"schemaVersion\":1,\"label\":\"üìä views\",\"message\":\"$VIEWS\",\"color\":\"$BADGE_COLOR\",\"style\":\"$BADGE_STYLE\"}" > "$DATA_DIR/visitors-badge.json"
          echo '{"schemaVersion": 1, "label": "‚≠ê stars", "message": "'$TOTAL_LIKES'", "color": "'$LIKES_COLOR'", "style": "'$BADGE_STYLE'"}' > "$DATA_DIR/likes-badge.json"

          # REPOSITORY INFO
          echo "üì¶ Fetching repository information..."
          REPO_INFO=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO")

          REPO_SIZE=$(echo "$REPO_INFO" | jq -r '.size // 0')
          REPO_SIZE_MB=$(echo "scale=1; $REPO_SIZE / 1024" | bc -l 2>/dev/null || echo "0")
          MAIN_LANGUAGE=$(echo "$REPO_INFO" | jq -r '.language // "Unknown"')
          LICENSE=$(echo "$REPO_INFO" | jq -r '.license.name // "No License"')

          echo '{"schemaVersion": 1, "label": "üì¶ size", "message": "'${REPO_SIZE_MB}'MB", "color": "blue", "style": "'$BADGE_STYLE'"}' > "$DATA_DIR/repo-size.json"

          echo '{"schemaVersion": 1, "label": "üìÑ license", "message": "'$LICENSE'", "color": "blue", "style": "'$BADGE_STYLE'"}' > "$DATA_DIR/repo-license.json"

          # RELEASES
          echo "üì¶ Fetching releases information..."
          RELEASES_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO/releases")

          # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–∞ –æ–±—Ä–æ–±–∫–∞ releases –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é —Ç–∏–ø—É
          TOTAL_DOWNLOADS=0
          if echo "$RELEASES_RESPONSE" | jq -e 'type == "array" and length > 0' >/dev/null 2>&1; then
            TOTAL_DOWNLOADS=$(echo "$RELEASES_RESPONSE" | jq '[.[] | select(.assets != null) | .assets[] | select(.download_count != null) | .download_count] | add // 0' 2>/dev/null || echo "0")
            echo "üì¶ Total downloads: $TOTAL_DOWNLOADS"
            echo '{"schemaVersion": 1, "label": "‚¨áÔ∏è downloads", "message": "'$TOTAL_DOWNLOADS'", "color": "orange", "style": "'$BADGE_STYLE'"}' > "$DATA_DIR/downloads-badge.json"
          else
            echo "üì¶ No releases found or API error"
          fi

          # === –¢–ï–•–ù–û–õ–û–ì–Ü–ß–ù–Ü –ë–ï–ô–î–ñ–Ü (–ª–∏—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ) ===
          echo "üîß Generating technology badges (used technologies only)..."
          TECH_BADGES=""
          ADD_BADGE() { [ -n "$1" ] && TECH_BADGES="$TECH_BADGES$1 "; }

          # GitHub API: –º–æ–≤–∏ –ø—Ä–æ–≥—Ä–∞–º—É–≤–∞–Ω–Ω—è
          LANGUAGES_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/$OWNER/$REPO/languages")

          if echo "$LANGUAGES_RESPONSE" | jq -e 'type == "object" and length > 0' >/dev/null 2>&1; then
            for lang in $(echo "$LANGUAGES_RESPONSE" | jq -r 'keys[]'); do
              case $lang in
                "HTML") ADD_BADGE "[![HTML5](https://img.shields.io/badge/HTML5-E34F26?style=for-the-badge&logo=html5&logoColor=white)](https://developer.mozilla.org/en-US/docs/Web/HTML)" ;;
                "CSS") ADD_BADGE "[![CSS3](https://img.shields.io/badge/CSS3-1572B6?style=for-the-badge&logo=css3&logoColor=white)](https://developer.mozilla.org/en-US/docs/Web/CSS)" ;;
                "JavaScript") ADD_BADGE "[![JavaScript](https://img.shields.io/badge/JavaScript-F7DF1E?style=for-the-badge&logo=javascript&logoColor=black)](https://developer.mozilla.org/en-US/docs/Web/JavaScript)" ;;
                "TypeScript") ADD_BADGE "[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)" ;;
                "Python") ADD_BADGE "[![Python](https://img.shields.io/badge/Python-3776AB?style=for-the-badge&logo=python&logoColor=white)](https://www.python.org/)" ;;
                "Java") ADD_BADGE "[![Java](https://img.shields.io/badge/Java-ED8B00?style=for-the-badge&logo=java&logoColor=white)](https://www.java.com/)" ;;
                "Vue") ADD_BADGE "[![Vue.js](https://img.shields.io/badge/Vue.js-4FC08D?style=for-the-badge&logo=vue.js&logoColor=white)](https://vuejs.org/)" ;;
                "SCSS") ADD_BADGE "[![Sass](https://img.shields.io/badge/Sass-CC6699?style=for-the-badge&logo=sass&logoColor=white)](https://sass-lang.com/)" ;;
                "PHP") ADD_BADGE "[![PHP](https://img.shields.io/badge/PHP-777BB4?style=for-the-badge&logo=php&logoColor=white)](https://www.php.net/)" ;;
                "Ruby") ADD_BADGE "[![Ruby](https://img.shields.io/badge/Ruby-CC342D?style=for-the-badge&logo=ruby&logoColor=white)](https://www.ruby-lang.org/)" ;;
                "Go") ADD_BADGE "[![Go](https://img.shields.io/badge/Go-00ADD8?style=for-the-badge&logo=go&logoColor=white)](https://go.dev/)" ;;
                "Rust") ADD_BADGE "[![Rust](https://img.shields.io/badge/Rust-000000?style=for-the-badge&logo=rust&logoColor=white)](https://www.rust-lang.org/)" ;;
                "Swift") ADD_BADGE "[![Swift](https://img.shields.io/badge/Swift-FA7343?style=for-the-badge&logo=swift&logoColor=white)](https://swift.org/)" ;;
                "Kotlin") ADD_BADGE "[![Kotlin](https://img.shields.io/badge/Kotlin-7F52FF?style=for-the-badge&logo=kotlin&logoColor=white)](https://kotlinlang.org/)" ;;
                "C") ADD_BADGE "[![C](https://img.shields.io/badge/C-A8B9CC?style=for-the-badge&logo=c&logoColor=white)](https://en.wikipedia.org/wiki/C_(programming_language))" ;;
                "C++") ADD_BADGE "[![C++](https://img.shields.io/badge/C++-00599C?style=for-the-badge&logo=cplusplus&logoColor=white)](https://isocpp.org/)" ;;
                "C#") ADD_BADGE "[![C#](https://img.shields.io/badge/C%23-239120?style=for-the-badge&logo=csharp&logoColor=white)](https://dotnet.microsoft.com/)" ;;
              esac
            done
          fi

          # package.json: dependencies, devDependencies —Ç–∞ stylelint config
          if [ -f "package.json" ]; then
            ADD_BADGE "[![Node.js](https://img.shields.io/badge/Node.js-339933?style=for-the-badge&logo=nodedotjs&logoColor=white)](https://nodejs.org/)"
            jq -e '.stylelint' package.json >/dev/null 2>&1 && ADD_BADGE "[![Stylelint](https://img.shields.io/badge/Stylelint-263238?style=for-the-badge&logo=stylelint&logoColor=white)](https://stylelint.io/)"
            for dep in vite postcss postcss-sort-media-queries stylelint glob axios swiper puppeteer react vue svelte typescript eslint prettier webpack rollup parcel tailwind bootstrap raty-js; do
              if jq -e ".devDependencies[\"$dep\"]" package.json >/dev/null 2>&1 || jq -e ".dependencies[\"$dep\"]" package.json >/dev/null 2>&1; then
                case $dep in
                  "vite") ADD_BADGE "[![Vite](https://img.shields.io/badge/Vite-646CFF?style=for-the-badge&logo=vite&logoColor=white)](https://vitejs.dev/)" ;;
                  "postcss") ADD_BADGE "[![PostCSS](https://img.shields.io/badge/PostCSS-DD3A0A?style=for-the-badge&logo=postcss&logoColor=white)](https://postcss.org/)" ;;
                  "stylelint") ADD_BADGE "[![Stylelint](https://img.shields.io/badge/Stylelint-263238?style=for-the-badge&logo=stylelint&logoColor=white)](https://stylelint.io/)" ;;
                  "axios") ADD_BADGE "[![Axios](https://img.shields.io/badge/Axios-5A29E4?style=for-the-badge&logo=axios&logoColor=white)](https://axios-http.com/)" ;;
                  "swiper") ADD_BADGE "[![Swiper](https://img.shields.io/badge/Swiper-6332F6?style=for-the-badge&logo=swiper&logoColor=white)](https://swiperjs.com/)" ;;
                  "puppeteer") ADD_BADGE "[![Puppeteer](https://img.shields.io/badge/Puppeteer-40B5A4?style=for-the-badge&logo=puppeteer&logoColor=white)](https://pptr.dev/)" ;;
                  "react") ADD_BADGE "[![React](https://img.shields.io/badge/React-61DAFB?style=for-the-badge&logo=react&logoColor=black)](https://react.dev/)" ;;
                  "vue") ADD_BADGE "[![Vue.js](https://img.shields.io/badge/Vue.js-4FC08D?style=for-the-badge&logo=vue.js&logoColor=white)](https://vuejs.org/)" ;;
                  "svelte") ADD_BADGE "[![Svelte](https://img.shields.io/badge/Svelte-FF3E00?style=for-the-badge&logo=svelte&logoColor=white)](https://svelte.dev/)" ;;
                  "typescript") ADD_BADGE "[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)](https://www.typescriptlang.org/)" ;;
                  "eslint") ADD_BADGE "[![ESLint](https://img.shields.io/badge/ESLint-4B32C3?style=for-the-badge&logo=eslint&logoColor=white)](https://eslint.org/)" ;;
                  "prettier") ADD_BADGE "[![Prettier](https://img.shields.io/badge/Prettier-F7B93E?style=for-the-badge&logo=prettier&logoColor=black)](https://prettier.io/)" ;;
                  "webpack") ADD_BADGE "[![Webpack](https://img.shields.io/badge/Webpack-8DD6F9?style=for-the-badge&logo=webpack&logoColor=black)](https://webpack.js.org/)" ;;
                  "rollup") ADD_BADGE "[![Rollup](https://img.shields.io/badge/Rollup-EC4A3F?style=for-the-badge&logo=rollup.js&logoColor=white)](https://rollupjs.org/)" ;;
                  "parcel") ADD_BADGE "[![Parcel](https://img.shields.io/badge/Parcel-000000?style=for-the-badge&logo=parcel&logoColor=white)](https://parceljs.org/)" ;;
                  "tailwind") ADD_BADGE "[![Tailwind CSS](https://img.shields.io/badge/Tailwind-38B2AC?style=for-the-badge&logo=tailwind-css&logoColor=white)](https://tailwindcss.com/)" ;;
                  "bootstrap") ADD_BADGE "[![Bootstrap](https://img.shields.io/badge/Bootstrap-7952B3?style=for-the-badge&logo=bootstrap&logoColor=white)](https://getbootstrap.com/)" ;;
                  "raty-js") ADD_BADGE "[![Raty.js](https://img.shields.io/badge/Raty.js-FFD700?style=for-the-badge&logo=star&logoColor=black)](https://www.npmjs.com/package/raty-js)" ;;
                esac
              fi
            done
            for dep in vite-plugin-full-reload vite-plugin-html-inject; do
              if jq -e ".dependencies[\"$dep\"]" package.json >/dev/null 2>&1 && ! echo "$TECH_BADGES" | grep -q "Vite"; then
                ADD_BADGE "[![Vite](https://img.shields.io/badge/Vite-646CFF?style=for-the-badge&logo=vite&logoColor=white)](https://vitejs.dev/)"
                break
              fi
            done
          fi

          # –ó–∞–≤–∂–¥–∏ –¥–æ–¥–∞—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ø—Ä–æ—î–∫—Ç—É
          ADD_BADGE "[![Terminal](https://img.shields.io/badge/Terminal-000000?style=for-the-badge&logo=windows-terminal&logoColor=white)](https://docs.microsoft.com/en-us/windows/terminal/)"
          ADD_BADGE "[![VS Code](https://img.shields.io/badge/VS_Code-007ACC?style=for-the-badge&logo=visual-studio-code&logoColor=white)](https://code.visualstudio.com/)"
          ADD_BADGE "[![GitHub](https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=github&logoColor=white)](https://github.com/)"
          ADD_BADGE "[![Figma](https://img.shields.io/badge/Figma-F24E1E?style=for-the-badge&logo=figma&logoColor=white)](https://www.figma.com/)"

          # –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ø—Ä–æ—î–∫—Ç—É: modern-normalize, SVGOMG, IcoMoon, Squoosh
          grep -q "modern-normalize" src/index.html 2>/dev/null && ADD_BADGE "[![Modern Normalize](https://img.shields.io/badge/Modern_Normalize-CC2927?style=for-the-badge)](https://cdnjs.com/libraries/modern-normalize)"
          [ -f "src/public/img/sprite.svg" ] && ADD_BADGE "[![SVGOMG](https://img.shields.io/badge/SVGOMG-FFB900?style=for-the-badge)](https://jakearchibald.github.io/svgomg/)"
          [ -f "src/public/img/sprite.svg" ] && ADD_BADGE "[![IcoMoon](https://img.shields.io/badge/IcoMoon-825794?style=for-the-badge)](https://icomoon.io/)"
          find src/img -name "*.webp" 2>/dev/null | head -1 | grep -q . && ADD_BADGE "[![Squoosh](https://img.shields.io/badge/Squoosh-4285F4?style=for-the-badge)](https://squoosh.app/)"

          echo "$TECH_BADGES" > "$DATA_DIR/tech-badges.txt"

          # Save user information
          echo "üíæ Saving detailed user information..."
          echo "{\"count\": $STARS_COUNT, \"users\": $STARGAZERS_DETAILED, \"updated_at\": \"$(date -u +\"%Y-%m-%d %H:%M:%S\")\"}" > "$STARGAZERS_FILE"

          # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
          MANUAL_LIKES_DETAILED=$(jq -r 'if .manual_likes.details then .manual_likes.details else [] end' "$STATS_FILE" 2>/dev/null || echo "[]")
          echo "{\"count\": $MANUAL_LIKES_COUNT, \"users\": $MANUAL_LIKES_DETAILED, \"updated_at\": \"$(date -u +\"%Y-%m-%d %H:%M:%S\")\"}" > "$MANUAL_LIKES_FILE"

          # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–µ –æ–±'—î–¥–Ω–∞–Ω–Ω—è –º–∞—Å–∏–≤—ñ–≤ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
          MANUAL_USERS=$(jq -r 'if .manual_likes.users then .manual_likes.users else [] end' "$STATS_FILE" 2>/dev/null || echo "[]")
          ALL_UNIQUE_USERS=$(echo "$STARS_USERS" | jq --argjson manual "$MANUAL_USERS" 'if type == "array" then (. + $manual | unique) else $manual end' 2>/dev/null || echo "[]")
          TOTAL_UNIQUE_USERS=$(echo "$ALL_UNIQUE_USERS" | jq 'length' 2>/dev/null || echo "0")

          # ‚úÖ FIX: –ë–µ–∑–ø–µ—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—ñ–Ω–∞–ª—å–Ω–æ–≥–æ JSON –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
          MANUAL_USERS_JSON=$(jq -r 'if .manual_likes.users then .manual_likes.users else [] end' "$STATS_FILE" 2>/dev/null || echo "[]")

          echo "{
            \"total_unique_users\": $TOTAL_UNIQUE_USERS,
            \"unique_visitors\": $VIEWS,
            \"stargazers\": {
              \"count\": $STARS_COUNT,
              \"users\": $STARS_USERS
            },
            \"manual_likes\": {
              \"count\": $MANUAL_LIKES_COUNT,
              \"users\": $MANUAL_USERS_JSON
            },
            \"all_engaged_users\": $ALL_UNIQUE_USERS,
            \"updated_at\": \"$(date -u +"%Y-%m-%d %H:%M:%S")\"
          }" > "$USERS_FILE"

          echo "‚úÖ All statistics collected: Views=$VIEWS, Stars=$STARS_COUNT, Manual=$MANUAL_LIKES_COUNT, Total=$TOTAL_LIKES"
          echo "üë• Total unique engaged users: $TOTAL_UNIQUE_USERS"

      - name: üñ• Setup Node.js and dependencies
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          echo "üîß Setting up Node.js..."
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs

          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"

          echo "üåê Setting up Chrome..."
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome-keyring.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable jq libgbm-dev

          echo "Chrome version: $(google-chrome-stable --version || echo 'Chrome not available')"

          echo "üì¶ Installing Puppeteer..."
          npm config set registry https://registry.npmjs.org/
          npm install --no-package-lock --no-save puppeteer@latest --timeout=120000

          if [ -d "node_modules/puppeteer" ]; then
            PUPPETEER_VERSION=$(node -e "console.log(require('./node_modules/puppeteer/package.json').version)")
            echo "‚úÖ Puppeteer is available: $PUPPETEER_VERSION"
            echo "SCREENSHOT_DEPENDENCIES_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "‚ùå Puppeteer could not be installed - screenshot functionality disabled"
            echo "SCREENSHOT_DEPENDENCIES_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: üì∏ Generate screenshot from GitHub Pages
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          if [ "$SCREENSHOT_DEPENDENCIES_AVAILABLE" = "false" ]; then
            echo "‚ùå Screenshot dependencies not available - skipping screenshot"
            echo "SCREENSHOT_CREATED=false" >> $GITHUB_ENV
            exit 0
          fi

          # ‚úÖ FIX: –ó–∞–≤–∂–¥–∏ –≤–∏–¥–∞–ª—è—î–º–æ —ñ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ —Å–∫—Ä—ñ–Ω—à–æ—Ç –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ
          if [ -f "$SCREENSHOT_DIR/screenshot.png" ]; then
            echo "üì∑ Removing existing screenshot for overwrite..."
            rm -f "$SCREENSHOT_DIR/screenshot.png" "$SCREENSHOT_DIR/screenshot.hash"
          fi

          node -e "
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');

          async function takeScreenshot() {
            let browser;
            try {
              const screenshotDir = process.env.SCREENSHOT_DIR || 'assets';
              const screenshotPath = path.resolve(screenshotDir, 'screenshot.png');
              
              if (!fs.existsSync(screenshotDir)) fs.mkdirSync(screenshotDir, { recursive: true });
              if (fs.existsSync(screenshotPath)) fs.unlinkSync(screenshotPath);
              
              let chromeExecutable = '/usr/bin/google-chrome';
              if (!fs.existsSync(chromeExecutable)) {
                try {
                  const chromePath = execSync('which google-chrome-stable || which google-chrome', { encoding: 'utf8' }).trim();
                  if (chromePath) chromeExecutable = chromePath;
                } catch (e) {
                  console.log('‚ùå Chrome not found:', e.message);
                  console.log('SCREENSHOT_SUCCESS=false');
                  return;
                }
              }

              console.log('Using Chrome executable:', chromeExecutable);
              
              const browserArgs = [
                '--no-sandbox',
                '--disable-setuid-sandbox',
                '--disable-dev-shm-usage',
                '--disable-web-security',
                '--disable-features=VizDisplayCompositor',
                '--headless',
                '--disable-gpu',
                '--disable-software-rasterizer',
                '--remote-debugging-port=0',
                '--no-zygote',
                '--no-first-run',
                '--disable-extensions',
                '--disable-background-timer-throttling',
                '--disable-backgrounding-occluded-windows',
                '--disable-renderer-backgrounding'
              ];

              browser = await puppeteer.launch({
                args: browserArgs,
                executablePath: chromeExecutable,
                timeout: 30000,
                dumpio: false
              });
              
              const page = await browser.newPage();
              await page.setViewport({ width: 1440, height: 900 });
              
              const githubPages = 'https://' + '${{ github.repository_owner }}' + '.github.io/' + '${{ github.event.repository.name }}' + '/';
              
              console.log('üåê Checking GitHub Pages availability...');
              console.log('üîó Target URL:', githubPages);
              
              try {
                const response = await page.goto(githubPages, { 
                  waitUntil: 'networkidle0', 
                  timeout: 30000 
                });
                
                if (!response || response.status() !== 200) {
                  console.log('‚ùå GitHub Pages returned status:', response?.status() || 'unknown');
                  console.log('SCREENSHOT_SUCCESS=false');
                  return;
                }
                
                const pageTitle = await page.title();
                const pageContent = await page.content();
                
                const hasMeaningfulContent = pageContent.length > 500 && 
                                           !pageTitle.includes('404') &&
                                           !pageContent.includes('There isn\\'t a GitHub Pages site here');
                
                if (!hasMeaningfulContent) {
                  console.log('‚ùå GitHub Pages has insufficient content');
                  console.log('SCREENSHOT_SUCCESS=false');
                  return;
                }
                
                console.log('‚úÖ GitHub Pages is accessible with meaningful content');
                console.log('üì∏ Taking screenshot...');
                
                // –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–µ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // –®–≤–∏–¥–∫–µ –ø—Ä–æ–≥–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑ –∞–Ω—ñ–º–∞—Ü—ñ–π
                await page.evaluate(() => {
                  return new Promise(resolve => {
                    let totalHeight = 0;
                    const distance = 200;
                    const timer = setInterval(() => {
                      const scrollHeight = document.body.scrollHeight;
                      window.scrollBy(0, distance);
                      totalHeight += distance;
                      
                      if (totalHeight >= scrollHeight) {
                        clearInterval(timer);
                        resolve();
                      }
                    }, 50);
                  });
                });
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                await page.evaluate(() => window.scrollTo(0, 0));
                await new Promise(resolve => setTimeout(resolve, 1000));

                // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Å–∫—Ä—ñ–Ω—à–æ—Ç–∞ - –ø—Ä–∏–±—Ä–∞–Ω–æ quality –¥–ª—è PNG
                await page.screenshot({ 
                  path: screenshotPath, 
                  fullPage: true,
                  type: 'png'
                });
                
                if (fs.existsSync(screenshotPath)) {
                  const stats = fs.statSync(screenshotPath);
                  const fileSizeKB = Math.round(stats.size / 1024);
                  
                  if (stats.size > 1000) {
                    console.log('‚úÖ Screenshot created successfully:', fileSizeKB + 'KB');
                    console.log('SCREENSHOT_SUCCESS=true');
                  } else {
                    console.log('‚ùå Screenshot file is too small:', fileSizeKB + 'KB');
                    fs.unlinkSync(screenshotPath);
                    console.log('SCREENSHOT_SUCCESS=false');
                  }
                } else {
                  console.log('‚ùå Screenshot file was not created');
                  console.log('SCREENSHOT_SUCCESS=false');
                }
                
              } catch (screenshotError) {
                console.log('‚ùå Screenshot process failed:', screenshotError.message);
                console.log('SCREENSHOT_SUCCESS=false');
              }
              
            } catch (error) {
              console.log('‚ùå Browser setup failed:', error.message);
              console.log('SCREENSHOT_SUCCESS=false');
            } finally {
              if (browser) {
                try {
                  await browser.close();
                } catch (closeError) {
                  console.log('‚ö†Ô∏è Browser close error:', closeError.message);
                }
              }
            }
          }

          takeScreenshot().catch(error => {
            console.log('‚ùå Unhandled error in screenshot process:', error.message);
            console.log('SCREENSHOT_SUCCESS=false');
          });
          " | tee screenshot_output.log

          if grep -q "SCREENSHOT_SUCCESS=true" screenshot_output.log; then
            echo "SCREENSHOT_CREATED=true" >> $GITHUB_ENV
            echo "üéØ Screenshot created successfully"
          else
            echo "SCREENSHOT_CREATED=false" >> $GITHUB_ENV
            echo "‚è≠Ô∏è Screenshot creation failed"
          fi

          if [ -f "$SCREENSHOT_DIR/screenshot.png" ]; then
            FILE_SIZE=$(wc -c < "$SCREENSHOT_DIR/screenshot.png" 2>/dev/null || echo 0)
            if [ "$FILE_SIZE" -lt 1000 ]; then
              echo "‚ö†Ô∏è Screenshot file exists but is too small ($FILE_SIZE bytes), removing..."
              rm -f "$SCREENSHOT_DIR/screenshot.png"
              echo "SCREENSHOT_CREATED=false" >> $GITHUB_ENV
            fi
          fi
          if [ "$SCREENSHOT_CREATED" = "true" ] && [ -f "$SCREENSHOT_DIR/screenshot.png" ]; then
            if command -v sha256sum >/dev/null 2>&1; then
              SCREENSHOT_HASH=$(sha256sum "$SCREENSHOT_DIR/screenshot.png" | awk '{print $1}')
            else
              SCREENSHOT_HASH=$(shasum -a 256 "$SCREENSHOT_DIR/screenshot.png" | awk '{print $1}')
            fi
            echo "$SCREENSHOT_HASH" > "$SCREENSHOT_DIR/screenshot.hash"
            echo "SCREENSHOT_HASH=$SCREENSHOT_HASH" >> $GITHUB_ENV
            echo "üîê Screenshot hash: $SCREENSHOT_HASH"
          fi

          rm -f screenshot_output.log

      - name: üìù Update README with all content
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/${{ github.ref_name }}"
          TECH_BADGES=$(cat $DATA_DIR/tech-badges.txt 2>/dev/null || echo "")

          DOWNLOADS_BADGE=""
          if [ -f "$DATA_DIR/downloads-badge.json" ]; then
            DOWNLOADS_BADGE="[![‚¨áÔ∏è Downloads](https://img.shields.io/endpoint?url=$REPO_URL/$DATA_DIR/downloads-badge.json)](https://github.com/${{ github.repository }}/releases)"
          fi

          SCREENSHOT_QUERY=""
          if [ "$SCREENSHOT_CREATED" = "true" ] && [ -f "$SCREENSHOT_DIR/screenshot.png" ]; then
            SCREENSHOT_SIZE=$(wc -c < "$SCREENSHOT_DIR/screenshot.png" 2>/dev/null || echo "0")
            if [ "$SCREENSHOT_SIZE" -gt 0 ]; then
              SCREENSHOT_HASH_VALUE="$SCREENSHOT_HASH"
              [ -z "$SCREENSHOT_HASH_VALUE" ] && [ -f "$SCREENSHOT_DIR/screenshot.hash" ] && SCREENSHOT_HASH_VALUE=$(cat "$SCREENSHOT_DIR/screenshot.hash")
              [ -n "$SCREENSHOT_HASH_VALUE" ] && SCREENSHOT_QUERY="?v=$SCREENSHOT_HASH_VALUE"
            fi
          fi

          CONTRIBUTORS_BADGE="[![Contributors](https://img.shields.io/github/contributors/${{ github.repository }}?logo=github)](https://github.com/${{ github.repository }}/graphs/contributors)"
          CONTRIBUTORS_IMAGE="[![Contributors](https://contrib.rocks/image?repo=${{ github.repository }}&max=20)](https://github.com/${{ github.repository }}/graphs/contributors)"

          update_readme() {
            local file="$1"
            local screenshot_title="$2"
            local contributors_title="$3"
            [ ! -f "$file" ] && return
            awk '/<!-- AUTOGEN:STATS -->/{exit} {print}' "$file" > "${file}.before.tmp"
            awk '/<!-- END:AUTOGEN -->/{found=1; next} found{print}' "$file" > "${file}.after.tmp"
            local screenshot_section=""
            if [ "$SCREENSHOT_CREATED" = "true" ] && [ -f "$SCREENSHOT_DIR/screenshot.png" ]; then
              screenshot_section=$(printf '\n\n## üì∏ %s\n![Project Screenshot](./%s/screenshot.png%s)' "$screenshot_title" "$SCREENSHOT_DIR" "$SCREENSHOT_QUERY")
            fi
            {
              cat "${file}.before.tmp"
              echo "<!-- AUTOGEN:STATS -->"
              echo "$TECH_BADGES"
              echo ""
              echo "[![üìä Views](https://img.shields.io/endpoint?url=$REPO_URL/$DATA_DIR/visitors-badge.json)](https://github.com/${{ github.repository }}/graphs/traffic)"
              echo "[![‚≠ê Stars](https://img.shields.io/endpoint?url=$REPO_URL/$DATA_DIR/likes-badge.json)](https://github.com/${{ github.repository }}/actions/workflows/screenshot-and-visitor.yaml)"
              echo "[![üë• Contributors](https://img.shields.io/github/contributors/${{ github.repository }})](https://github.com/${{ github.repository }}/graphs/contributors)"
              echo "[![üì¶ Size](https://img.shields.io/endpoint?url=$REPO_URL/$DATA_DIR/repo-size.json)](https://github.com/${{ github.repository }})"
              echo "[![üìÑ License](https://img.shields.io/endpoint?url=$REPO_URL/$DATA_DIR/repo-license.json)](https://github.com/${{ github.repository }}/blob/main/LICENSE)"
              [ -n "$DOWNLOADS_BADGE" ] && echo "$DOWNLOADS_BADGE"
              echo "$screenshot_section"
              echo ""
              echo "## üë• $contributors_title"
              echo "$CONTRIBUTORS_BADGE"
              echo ""
              echo "$CONTRIBUTORS_IMAGE"
              echo "<!-- END:AUTOGEN -->"
              cat "${file}.after.tmp"
            } > "$file"
            rm -f "${file}.before.tmp" "${file}.after.tmp"
            echo "‚úÖ Updated $file"
          }

          update_readme "README.md" "–°–∫—Ä—ñ–Ω—à–æ—Ç –ø—Ä–æ–µ–∫—Ç—É" "–ö–æ–Ω—Ç—Ä–∏–±'—é—Ç–æ—Ä–∏"
          update_readme "README.en.md" "Project screenshot" "Contributors"
          update_readme "README.de.md" "Projektscreenshot" "Mitwirkende"

          echo "‚úÖ All README files updated with stats, screenshot, Contributors"

      - name: üì§ Commit and deploy
        if: steps.check_commit.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .

          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∑–º—ñ–Ω
          if git diff --cached --quiet; then
            echo "üîÑ No changes to commit"
            exit 0
          fi

          COMMIT_MSG="üìä Auto-update: visitors, likes"
          if [ "$SCREENSHOT_CREATED" = "true" ]; then
            COMMIT_MSG="$COMMIT_MSG, and screenshot"
          fi

          git commit -m "$COMMIT_MSG"

          # –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –≤—ñ–¥–¥–∞–ª–µ–Ω–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—î–º –ø–µ—Ä–µ–¥ –ø—É—à–µ–º
          git pull --rebase origin ${{ github.ref_name }} || true
          # ‚úÖ FIX: Push –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î PAT_TOKEN –∑ checkout, —Ç–æ–º—É –ø—Ä–æ—Å—Ç–æ push
          git push origin ${{ github.ref_name }}

          echo "üìÑ Triggering updates..."
          if curl -s -f -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pages" >/dev/null 2>&1; then
            curl -s -X POST -H "Authorization: token ${{ secrets.PAT_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pages/builds" >/dev/null || true
          fi

          echo "‚úÖ All updates completed successfully"
